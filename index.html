<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Order Digital Card - Agrawal Futurify</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; max-width:720px; margin:24px auto; }
    label { display:block; margin-top:12px; }
    input, textarea { width:100%; padding:8px; box-sizing:border-box; }
    button { margin-top:12px; padding:10px 16px; }
    .error { color:#b00020; }
    .success { color:#006400; }
    #status { margin-top:12px; min-height:20px; }
  </style>
</head>
<body>
  <h1>Order Digital Card</h1>
  <form id="orderForm">
    <label>Name <input id="name" name="name" required /></label>
    <label>Email <input id="email" name="email" type="email" required /></label>
    <label>Amount (INR) <input id="amount" name="amount" type="number" step="0.01" required /></label>
    <label>Message <textarea id="message" name="message"></textarea></label>
    <label>Upload Image (optional) <input id="image" type="file" accept="image/*" /></label>
    <div id="status"></div>
    <button type="submit">Pay & Order</button>
  </form>

  <script>
    // === CONFIG: Replace this with your Apps Script Web App URL after deployment ===
    const BACKEND_URL = 'BACKEND_WEB_APP_URL';

    // Load Razorpay checkout script dynamically
    function loadRazorpayScript() {
      return new Promise((resolve, reject) => {
        if (window.Razorpay) return resolve();
        const s = document.createElement('script');
        s.src = 'https://checkout.razorpay.com/v1/checkout.js';
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load Razorpay SDK'));
        document.head.appendChild(s);
      });
    }

    function showStatus(msg, cls) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = cls || '';
    }

    async function postJson(url, body) {
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const text = await resp.text();
      try { return JSON.parse(text); } catch (e) { throw new Error('Invalid JSON from backend: ' + text); }
    }

    document.getElementById('orderForm').addEventListener('submit', async function (ev) {
      ev.preventDefault();
      showStatus('Preparing order...', '');
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const amount = document.getElementById('amount').value.trim();
      const message = document.getElementById('message').value.trim();
      const fileInput = document.getElementById('image');
      let imageBase64 = null;

      if (!BACKEND_URL || BACKEND_URL === 'BACKEND_WEB_APP_URL') {
        showStatus('Backend URL not configured in frontend. Replace BACKEND_WEB_APP_URL in index.html', 'error');
        return;
      }

      if (fileInput.files && fileInput.files[0]) {
        showStatus('Reading image...', '');
        try {
          imageBase64 = await toBase64(fileInput.files[0]);
        } catch (err) {
          showStatus('Image read failed: ' + err.message, 'error');
          return;
        }
      }

      // Create order on backend
      try {
        const createResp = await postJson(BACKEND_URL, {
          mode: 'create',
          customerName: name,
          customerEmail: email,
          amount: amount,
          notes: { message: message }
        });
        if (!createResp || !createResp.success) {
          showStatus('Order creation failed: ' + (createResp && createResp.error ? createResp.error : 'unknown'), 'error');
          return;
        }
        const keyId = createResp.keyId;
        const order = createResp.order;
        const clientOrderId = createResp.clientOrderId;

        // If image present, upload and attach to order (base64)
        if (imageBase64) {
          showStatus('Uploading image...', '');
          const uploadResp = await postJson(BACKEND_URL, {
            mode: 'uploadImage',
            clientOrderId: clientOrderId,
            filename: 'card-image-' + clientOrderId + '.png',
            imageBase64: imageBase64.replace(/^data:image\/[a-z]+;base64,/, ''),
            mimeType: 'image/png'
          });
          if (uploadResp && uploadResp.success) {
            console.log('Image uploaded', uploadResp.url);
          } else {
            console.warn('Image upload failed', uploadResp);
          }
        }

        // Load Razorpay SDK
        await loadRazorpayScript();

        // Build options for Razorpay Checkout
        const options = {
          key: keyId,
          amount: order.amount,
          currency: order.currency,
          name: 'Agrawal Futurify',
          description: 'Order ' + clientOrderId,
          order_id: order.id,
          prefill: { name: name, email: email },
          handler: async function (response) {
            showStatus('Verifying payment...', '');
            try {
              const verifyResp = await postJson(BACKEND_URL, {
                mode: 'verifyPayment',
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
                razorpay_signature: response.razorpay_signature,
                clientOrderId: clientOrderId
              });
              if (verifyResp && verifyResp.success) {
                showStatus('Payment successful. Activation link sent to email.', 'success');
                console.log('Activation URL:', verifyResp.activationUrl);
              } else {
                showStatus('Verification failed: ' + (verifyResp && verifyResp.error ? verifyResp.error : 'unknown'), 'error');
              }
            } catch (err) {
              showStatus('Verification request failed: ' + err.message, 'error');
            }
          },
          modal: {
            ondismiss: function() {
              showStatus('Payment popup closed or cancelled', 'error');
            }
          }
        };

        // Open Razorpay popup
        const rzp = new Razorpay(options);
        rzp.open();
        showStatus('Razorpay popup opened. Complete payment to proceed.', '');
      } catch (err) {
        showStatus('Request failed: ' + err.message, 'error');
      }
    });

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
